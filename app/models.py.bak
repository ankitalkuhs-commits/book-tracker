# app/models.py
"""
Models for BookPulse (SQLModel).
- Uses SQLModel (a thin wrapper over SQLAlchemy) to define tables.
- Keep relationships simple and clear for CRUD operations.
"""

from typing import Optional, List
from datetime import datetime
from sqlmodel import Field, Relationship, SQLModel


class User(SQLModel, table=True):
    """Application user."""
    id: Optional[int] = Field(default=None, primary_key=True)
    email: str = Field(sa_column_kwargs={"unique": True, "nullable": False}, index=True)
    name: Optional[str] = None
    hashed_password: str = Field(nullable=False)
    bio: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationships
    userbooks: List["UserBook"] = Relationship(back_populates="user")
    notes: List["Note"] = Relationship(back_populates="user")


class Book(SQLModel, table=True):
    """Global book record. One book row represents a title/edition we have metadata for."""
    id: Optional[int] = Field(default=None, primary_key=True)
    title: str = Field(nullable=False)
    author: Optional[str] = None
    description: Optional[str] = None
    format: Optional[str] = None  # e.g., 'Kindle', 'Owned', 'Borrowed', 'Audiobook'
    total_pages: Optional[int] = None
    pages_source: Optional[str] = None  # e.g., 'openlibrary', 'googlebooks', 'user'
    cover_url: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationships
    userbooks: List["UserBook"] = Relationship(back_populates="book")
    # Optionally: notes can reference book indirectly via UserBook, so no direct notes Relationship here.


class UserBook(SQLModel, table=True):
    """Join table connecting users to books with reading status and progress."""
    id: Optional[int] = Field(default=None, primary_key=True)
    user_id: int = Field(foreign_key="user.id", index=True)
    book_id: int = Field(foreign_key="book.id", index=True)
    status: str = Field(default="to-read")  # 'to-read' | 'reading' | 'finished'
    current_page: Optional[int] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationships
    user: Optional[User] = Relationship(back_populates="userbooks")
    book: Optional[Book] = Relationship(back_populates="userbooks")
    notes: List["Note"] = Relationship(back_populates="userbook")


class Note(SQLModel, table=True):
    """A short emotional note / post tied to a user and optionally a UserBook."""
    id: Optional[int] = Field(default=None, primary_key=True)
    userbook_id: Optional[int] = Field(default=None, foreign_key="userbook.id", index=True)
    user_id: int = Field(foreign_key="user.id", index=True)
    text: Optional[str] = None
    emotion: Optional[str] = None  # e.g., 'joy', 'sad', 'inspired', 'calm'
    is_public: bool = Field(default=True)
    created_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationships
    user: Optional[User] = Relationship(back_populates="notes")
    userbook: Optional[UserBook] = Relationship(back_populates="notes")


class Follow(SQLModel, table=True):
    """Follow relationship: follower -> followed (both users)."""
    id: Optional[int] = Field(default=None, primary_key=True)
    follower_id: int = Field(foreign_key="user.id", index=True)
    followed_id: int = Field(foreign_key="user.id", index=True)
    created_at: datetime = Field(default_factory=datetime.utcnow)
